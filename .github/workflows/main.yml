name: Django-app workflow

on: [push]
jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        # обновление pip
        python -m pip install --upgrade pip

        # установка flake8 и его плагинов
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort

        # установка зависимостей
        pip install -r requirements.txt

    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8 
        # перейти в папку, содержащую manage.py
        cd infra_project/
        # запустить тесты разработчика
        python manage.py test

  build_and_push_to_docker_hub:
    name: Push Docker Image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
      # Проверка доступности Docker Hub
        uses: actions/checkout@v2
      - name: Set up Docker buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to Docker
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to docker hub
        uses: docker/build-push-action@v2
        with:
         push: true
         tags: govorlivyh/infra-actions:latest
  
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
      - name: executing remote ssh commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: govorlivyh
          key: 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
          passphrase: 92rocknroll
          script: |
            # Выполняет pull образа c Docker Hub
            sudo docker pull govorlivyh/infra_actions
            # Остановка всех контейнеров 
            sudo docker stop $(sudo docker ps -a -q)
            sudo docker run --rm -p 5000:5000 govorlivyh/infra_actions
